# ElectricFence
ç”µå­å›´æ ,åŒºåŸŸç›‘å¬demo
#### 1.å‰è¨€:
* è¿™ç¯‡çš„ä¸»é¢˜å†™çš„ä¸æ˜¯åŸºç¡€å®ç°,å¦‚æœæƒ³çœ‹å…¥é—¨ç¯‡å¯ä»¥çœ‹ä¸‹é¢çš„æ–‡ç« :
[iOSåœ°å›¾ -- åŒºåŸŸç›‘å¬çš„å®ç°å’Œå°ç»ƒä¹ ](https://www.cnblogs.com/gchlcc/p/5844028.html)
[Core Location ç”µå­å›´æ ï¼šå…¥é—¨](https://blog.csdn.net/kmyhy/article/details/81665195)
* å½“ç„¶,å¦‚æœä½ é›†æˆçš„æ˜¯ä¸‰æ–¹æ¡†æ¶,æ¯”å¦‚ç™¾åº¦åœ°å›¾å’Œé«˜å¾·åœ°å›¾,é‚£ä½ å°±ç…§ç€å®˜æ–¹æ–‡æ¡£æ¥.
* è¿™ç¯‡ä¸»è¦æ˜¯è®°å½•æˆ‘åœ¨å®è·µçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›ç–‘é—®ä»¥åŠè§£å†³çš„è¿‡ç¨‹.è¿™å…¶ä¸­çš„ç‚¹æ˜¯ç½‘ä¸Šä¸€äº›å…¥é—¨æ–‡ç« æ²¡æœ‰æåˆ°.æ‰€ä»¥ä¸€æ–¹é¢æ˜¯å¯¹è‡ªå·±çš„æ€»ç»“æ–¹ä¾¿ä»¥åæ¸©æ•…è€ŒçŸ¥æ–°,å¦ä¸€æ–¹é¢ä¹Ÿå¸Œæœ›å¯ä»¥å¸®åˆ°ä¸€äº›åˆšæ¥è§¦è¿™æ–¹é¢çš„äºº
#### 2.å…³äºä½ç½®è®¿é—®æƒé™çš„é—®é¢˜:
* ç”µå­å›´æ åŠŸèƒ½éœ€è¦ç”¨æˆ·åŒæ„**"å§‹ç»ˆè®¿é—®"**è¿™ä¸€é¡¹,**"ä»…ä½¿ç”¨æœŸé—´"**å’Œ**"æ‹’ç»è®¿é—®"**è¿™ä¸¤ä¸ªæƒé™éƒ½ä¼šä½¿è¯¥åŠŸèƒ½ä¸èƒ½è¾¾åˆ°é¢„æœŸçš„æ•ˆæœ,ä¼šæœ‰é—®é¢˜.æ‹’ç»çŠ¶æ€ç›´æ¥å¯¼è‡´è¯¥åŠŸèƒ½æ— æ³•ä½¿ç”¨.ä»…ä½¿ç”¨æœŸé—´ä¼šå¯¼è‡´Appé€€åˆ°åå°æˆ–è€…åœ¨æ§åˆ¶ä¸­å¿ƒæ‰‹åŠ¨æ€æ‰åä¸èƒ½æ­£å¸¸ä½¿ç”¨.
* æ‰€ä»¥,æ¯æ¬¡ä½¿ç”¨è¯¥åŠŸèƒ½å‰,æœ€å¥½è·å–ä¸€ä¸‹ç”¨æˆ·çš„æƒé™è®¾ç½®,å¦‚æœæ˜¯æ‹’ç»çŠ¶æ€å¯ä»¥æç¤ºç”¨æˆ·,å¹¶å¼•å¯¼è·³è½¬åˆ°æƒé™è®¾ç½®ç•Œé¢.å¦‚æœæ˜¯ä»…ä½¿ç”¨æœŸé—´çŠ¶æ€,å¯ä»¥ç»™ä¸ç”¨æˆ·æç¤ºåˆ‡æ¢æˆå§‹ç»ˆè®¿é—®æƒé™.
#### 3.å…³äºCLRegion:
è¯·ä½¿ç”¨CLRegionçš„å­ç±»,æ¯”å¦‚:CLCircularRegion.
#### 4.æ ¸å¿ƒä»£ç (swiftä¸ºä¾‹):
```
// åˆ›å»ºç›‘å¬åŒºåŸŸ
let region = CLCircularRegion.init(center: coordinate, radius: distance, identifier: type.rawValue)
// å¼€å§‹ç›‘å¬
self.locationManager.startMonitoring(for: region)
// å»¶æ—¶2ç§’åè·å–å›´æ çŠ¶æ€(ä¸ºä»€ä¹ˆå»¶æ—¶,è¯·çœ‹åæ–‡)
DispatchQueue.main.asyncAfter(deadline: .now() + 2) {
  self.locationManager.requestState(for: region)
}
```
* è°ƒç”¨startMonitoringå¼€å§‹ç›‘å¬.è®¾ç½®ä»£ç†åä¸»è¦å…³æ³¨ä»¥ä¸‹ä»£ç†å›è°ƒ:
```
    func locationManager(_ manager: CLLocationManager, didEnterRegion region: CLRegion) {
        print("...è¿›å…¥ç”µå­å›´æ ...")
    }
    
    
    func locationManager(_ manager: CLLocationManager, didExitRegion region: CLRegion) {
        print("...ç¦»å¼€ç”µå­å›´æ ...")
    }
    
    
    func locationManager(_ manager: CLLocationManager, monitoringDidFailFor region: CLRegion?, withError error: Error) {
        print("...ç›‘å¬å›´æ å¤±è´¥:\(region!), error:\(error)")
    }
    
    
    func locationManager(_ manager: CLLocationManager, didStartMonitoringFor region: CLRegion) {
        print("...å¼€å§‹ç›‘å¬...")
    }
```
* è°ƒç”¨requestStateæ–¹æ³•å¯ä»¥è·å–åˆ°å½“å‰ä½ç½®çŠ¶æ€,è®¾ç½®ä»£ç†åä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç†å›è°ƒ:
```
    func locationManager(_ manager: CLLocationManager, didDetermineState state: CLRegionState, for region: CLRegion) {
        let regionType = RegionType.init(rawValue: region.identifier)
        guard regionType != .unknown else {return}
        let str = state == .inside ? "çŠ¶æ€: ç”µå­å›´æ å†…" : (state == .outside ? "çŠ¶æ€: ç”µå­å›´æ å¤–" : "çŠ¶æ€: æœªçŸ¥")
        if regionType == .company
        {
            self.clabel.text = str
        }
        else
        {
            self.hLabel.text = str
        }
    }
```
#### 5.å…³äºç›‘å¬ç”µå­å›´æ æ•°é‡é—®é¢˜:
* ä¸€ä¸ªAppæœ€å¤šåªèƒ½åŒæ—¶ç›‘å¬20ä¸ªç”µå­å›´æ ,è¶…è¿‡åä¼šèµ°monitoringDidFailå›è°ƒ.ä¼šæŠ¥(Domain=kCLErrorDomain Code=5)çš„é”™è¯¯æç¤º.
#### 6.å…³äºstartMonitoringæ–¹æ³•å’ŒrequestStateæ–¹æ³•çš„åŒºåˆ«,ä»¥åŠä¸ºä½•è¦requestStateå»¶æ—¶è°ƒç”¨é—®é¢˜
* å¯¹äºstartMonitoringå’ŒrequestStateçš„åŒºåˆ«,è¿™é‡Œæ˜¯æˆ‘è‡ªå·±çš„ä¸€äº›ç†è§£,å¯èƒ½å¯¹å¯èƒ½ä¸å¯¹,ä»…ä¾›å‚è€ƒ.
* startMonitoringè°ƒç”¨å,å³å°±å¼€å§‹äº†å›´æ çš„ç›‘å¬,åªè¦æ²¡æœ‰ç§»é™¤ç›‘å¬,ä¸€æ—¦çŠ¶æ€å‘ç”Ÿå˜åŒ–,å°±ä¼šèµ°å¯¹åº”çš„ä»£ç†å›è°ƒæ–¹æ³•.
* requestStateçœ‹å®˜æ–¹æ³¨é‡Šä¸éš¾ç†è§£,å¼‚æ­¥çš„è·å–å½“å‰ç”µå­å›´æ çš„çŠ¶æ€(æ˜¯å¦åœ¨ç”µå­å›´æ å†…,æ˜¯å¦åœ¨ç”µå­å›´æ å¤–å’ŒæœªçŸ¥çŠ¶æ€).
* ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨startMonitoringå¼€å¯åŒºåŸŸç›‘å¬å,éƒ½ä¼šè°ƒç”¨requestStateæ¥è·å–ä¸€ä¸‹åˆå§‹çŠ¶æ€.ä¸ºä½•å»¶æ—¶æ˜¯å› ä¸ºå¦‚æœç«‹å³è°ƒç”¨çš„è¯,ä¼šæœ‰æ¦‚ç‡æŠ¥(Domain=kCLErrorDomain Code=5)çš„é”™è¯¯æ,å¯¼è‡´è·å–å¤±è´¥.
#### 7.é’ˆå¯¹åœ¨å§‹ç»ˆè®¿é—®æƒé™ä¸‹Appè¢«é”€æ¯å,å…³äºç§»é™¤ç”µå­å›´æ ä½ éœ€è¦æ³¨æ„çš„é—®é¢˜
* é¦–å…ˆæä¸¤ä¸ªé—®é¢˜,å¦‚æœæˆ‘ç›‘å¬äº†æŸä¸ªåŒºåŸŸ,ç„¶ååœ¨æ§åˆ¶ä¸­å¿ƒé”€æ¯äº†App.è¯·é—®æ­¤æ—¶,è¿™ä¸ªåŒºåŸŸç›‘å¬çš„åŠŸèƒ½è¿˜ç”Ÿæ•ˆå—?ä¸‹ä¸€æ¬¡è¿›å…¥Appçš„æ—¶å€™,æ˜¯å¦éœ€è¦é‡æ–°ç›‘å¬.
* é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜.é€šè¿‡ä»£ç æµ‹è¯•å,æˆ‘å¾—åˆ°äº†ä»¥ä¸‹ç»“æœ.å½“å¤„äº"å§‹ç»ˆè®¿é—®ä½ç½®"æƒé™æ—¶,åªè¦æ²¡æœ‰é€šè¿‡ä»£ç æ¥ç§»é™¤ç›‘å¬,å³ä½¿Appè¢«é”€æ¯äº†.ç³»ç»Ÿè¿˜æ˜¯ä¼šç»§ç»­å¤„äºç›‘å¬çŠ¶æ€.è¿™ä¸ªé€šè¿‡æ‰‹æœºå±å¹•çŠ¶æ€æ å·¦ä¸Šè§’ä½ç½®è®¿é—®å°è§’æ ‡å¹¶æ²¡æœ‰æ¶ˆå¤±å°±å¯ä»¥ç¡®å®š![880DC4D0F5DD8C41F766C1D797404985.png](https://upload-images.jianshu.io/upload_images/3096223-36136684c6432651.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
* é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜:CLLocationManageræœ‰ä¸€ä¸ªå¯ä»¥è·å–å½“å‰ç›‘å¬äº†å“ªäº›ç”µå­å›´æ çš„é›†åˆ.
![4FC4D04F-3CBD-4D40-87BB-44DA132CA769.png](https://upload-images.jianshu.io/upload_images/3096223-6b4dec441c1ce49a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
>å®è·µ:
1.å½“æˆ‘æ²¡æœ‰å¼€å§‹ç›‘å¬æ—¶,è·å–æ­¤é›†åˆçš„count = 0;
2.å½“æˆ‘å¼€å¯ä¸€ä¸ªç”µå­å›´æ å,é”€æ¯App.ç„¶åé‡å¯App.è·å–æ­¤é›†åˆçš„count = 1
ç»“è®º:
Appè¢«é”€æ¯å,ä¸‹æ¬¡é‡å¯App.ä¹‹å‰æ²¡æœ‰ç§»é™¤çš„ç”µå­å›´æ ä»ç„¶å¤„äºç›‘å¬çŠ¶æ€.ä¸éœ€è¦é‡æ–°æ·»åŠ .
**æ‰€ä»¥:è¿™é‡Œéœ€è¦ç‰¹åˆ«æ³¨æ„,å‰é¢æåˆ°äº†ä¸€ä¸ªAppæœ€å¤šåªèƒ½ç›‘å¬20ä¸ªåŒºåŸŸ.å› æ­¤ç”µå­å›´æ çš„ç›‘å¬å’Œç§»é™¤ç®¡ç†,è‡ªå·±è¦å¿ƒé‡Œç‰¹åˆ«æ¸…æ™°.å“ªäº›ä¸ç”¨äº†éœ€è¦åŠæ—¶ç§»é™¤,å¦åˆ™ä¼šå ç”¨ä¸å¿…è¦çš„åé¢.å¦å¤–ä¸€ç‚¹å°±æ˜¯,å¦‚æœæŸä¸ªç”µå­å›´æ ä¸éœ€è¦ç›‘å¬äº†è¯·åŠæ—¶ç§»é™¤,å¦åˆ™,å³ä½¿ç”¨æˆ·é”€æ¯äº†App,ä»ç„¶è¿˜æ˜¯ä¼šå ç”¨ç³»ç»Ÿèµ„æº,èƒŒåœ°é‡Œåœ¨ä½¿ç”¨ç”¨æˆ·çš„ä½ç½®æƒé™.ä½œä¸ºå¼ºè¿«ç—‡çš„æˆ‘å¯å—ä¸äº†.**
#### 8.æœ€åå†è¯´ä¸€ä¸‹didEnterRegionå’ŒdidExitRegionè¿™ä¸¤ä¸ªä»£ç†å›è°ƒçš„æ‰§è¡Œ
* ä¸€ä¸ªæ˜¯è¿›å…¥ç”µå­å›´æ ä¼šè§¦å‘,ä¸€ä¸ªæ˜¯ç¦»å¼€ç”µå­å›´æ ä¼šè§¦å‘
* appå¤„äºåå°,çŠ¶æ€å‘ç”Ÿæ”¹å˜äº†.å›è°ƒæ˜¯å¦ä¼šè°ƒç”¨ --> ç­”æ¡ˆæ˜¯ä¼šçš„
* appè¢«é”€æ¯å,ç”µå­å›´æ å¤„äºç›‘å¬çŠ¶æ€,çŠ¶æ€å‘ç”Ÿæ”¹å˜å,å›è°ƒæ˜¯å¦ä¼šè¢«è°ƒç”¨ --> æˆ‘ä¹‹å‰å¿ƒé‡Œæƒ³ç€æ˜¯ä¸ä¼š,å› ä¸ºAppéƒ½è¢«é”€æ¯äº†,å†…éƒ¨ä»£ç åº”è¯¥ä¸ä¼šæ‰§è¡Œå§.ç»“æœæˆ‘é€šè¿‡æ³¨å†Œæœ¬åœ°é€šçŸ¥çš„æ–¹å¼æ¥éªŒè¯å,ç­”æ¡ˆæ˜¯ä¾ç„¶ä¼šæ‰§è¡Œ.
ä»£ç å¦‚ä¸‹:
```
    func locationManager(_ manager: CLLocationManager, didEnterRegion region: CLRegion) {
        print("...è¿›å…¥ç”µå­å›´æ ...")
        self.locationManager.requestState(for: region)
        let type = RegionType.init(rawValue: region.identifier)!
        let str = type == .home ? "ğŸ " : "å…¬å¸"
        self.addLocalNotification(body: "ä½ å·²ç»è¿›å…¥\(str)ç”µå­å›´æ å†…")
    }
    
    
    func locationManager(_ manager: CLLocationManager, didExitRegion region: CLRegion) {
        print("...ç¦»å¼€ç”µå­å›´æ ...")
        self.locationManager.requestState(for: region)
        let type = RegionType.init(rawValue: region.identifier)!
        let str = type == .home ? "ğŸ " : "å…¬å¸"
        self.addLocalNotification(body: "ä½ å·²ç»ç¦»å¼€\(str)ç”µå­å›´æ ")
    }
```
ä»£ç æ€è·¯å¾ˆç®€å•,æˆ‘æŠŠæ³¨å†Œæœ¬åœ°é€šçŸ¥çš„ä»£ç å†™åœ¨äº†ä»£ç†å›è°ƒé‡Œ.å¦‚æœå›è°ƒæ‰§è¡Œäº†,é‚£ä¹ˆæœ¬åœ°é€šçŸ¥å°±èƒ½æ³¨å†ŒæˆåŠŸ,æˆ‘å°±èƒ½æ”¶åˆ°é€šçŸ¥.å¦‚æœä¸æ‰§è¡Œ,æœ¬åœ°é€šçŸ¥å°±ä¸ä¼šè¢«æ³¨å†Œ,æˆ‘å°±æ”¶ä¸åˆ°é€šçŸ¥.æœ€åç»“æœå¦‚å›¾:
![0927B894-6F6A-4D3D-A22F-25E0D8A8ABB4.png](https://upload-images.jianshu.io/upload_images/3096223-6a7cc11a801ef47c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 9.å†™åœ¨æœ€å
åœ¨éªŒè¯ä¸Šæ–‡é‚£äº›å†…å®¹çš„æ—¶å€™,æˆ‘é¡ºå¸¦å†™äº†ä¸€ä¸ªå°é¡¹ç›®,demoé‡Œå¼„äº†2ä¸ªç”µå­å›´æ ,ä¸€ä¸ªæ˜¯å…¬å¸çš„ä¸€ä¸ªæ˜¯ç§Ÿæˆ¿çš„.æ¯å¤©ä¸Šä¸‹ç­å¯ä»¥ç›‘å¬æˆ‘æ˜¯å¦åˆ°å…¬å¸äº†,æ˜¯å¦åˆ°å®¶äº†.æ— è®ºæ˜¯ç¦»å¼€è¿˜æ˜¯è¿›å…¥ç”µå­å›´æ éƒ½ä¼šç»™æˆ‘å‘ä¸ªæœ¬åœ°é€šçŸ¥.ç„¶åå°±æ˜¯å½“æ—¶Domain=kCLErrorDomain Code=5è¿™ä¸ªé—®é¢˜å›°ä½äº†æˆ‘è®¸ä¹….è§£å†³çš„æ—¶å€™å‚è€ƒäº†ä»¥ä¸‹æ–‡ç« (å…¶å®æ²¡å¸®åˆ°æˆ‘ä»€ä¹ˆ,ä½†æ˜¯code=5çš„åŸå› å¾ˆå¤š,å¦‚æœä½ ä¹Ÿé‡åˆ°äº†,ä¹Ÿè®¸è¿™é‡Œä¼šæœ‰ä½ æƒ³è¦çš„):
* https://github.com/evothings/phonegap-estimotebeacons/issues/94
* https://stackoverflow.com/questions/17733875/corelocation-kclerrordomain-error-5

[æœ€åé™„ä¸Šç®€ä¹¦åœ°å€,æ¬¢è¿ç•™è¨€äº¤æµ](https://www.jianshu.com/p/e7015207ecef)
